---
- hosts: localhost
  connection: local
  become: yes

  vars:
    # Where your code lives
    app_dir: "/home/cbtrophy/cbTrophyPi"
    # Your private repo
    firmware_repo: "git@github.com:CrunchyBytesDev/cbTrophyPi.git"

  tasks:
    # --- STAGE 0: HARDWARE SANITIZATION (The Anti-Flicker Suite) ---

    - name: Permanently disable Audio Kernel Modules (Prevents GPIO Conflicts)
      block:
        - name: Add sound module to blacklist
          copy:
            dest: /etc/modprobe.d/alsa-blacklist.conf
            content: |
              blacklist snd_bcm2835
              blacklist snd_pcm
              blacklist snd_timer
              blacklist snd
              install snd_bcm2835 /bin/false
            owner: root
            group: root
            mode: '0644'

        - name: Ensure audio is disabled in config.txt
          lineinfile:
            path: /boot/firmware/config.txt
            regexp: '^dtparam=audio='
            line: 'dtparam=audio=off'
          register: config_audio
          ignore_errors: yes

        - name: Force unload sound module immediately
          modprobe:
            name: snd_bcm2835
            state: absent
          failed_when: false

    - name: Disable Services known to cause LED Matrix Flicker
      systemd:
        name: "{{ item }}"
        state: stopped
        enabled: no
        masked: yes  # Ensures they NEVER start automatically
      loop:
        - cron              # Periodic tasks kill timing
        - dphys-swapfile    # Swapping to SD card kills timing
        - cups              # Printer discovery
        - avahi-daemon      # mDNS scanning
        - systemd-timesyncd # We will control this manually via Timer
      ignore_errors: yes

    # --- STAGE 0.5: DEPLOY SNIPER SYNC (Controlled Time Updates) ---

    - name: Deploy Periodic "Sniper" Time Sync Service & Timer
      copy:
        dest: "/etc/systemd/system/{{ item.name }}"
        content: "{{ item.content }}"
        mode: '0644'
      loop:
        # 1. The Service: Wakes up, syncs fast, then dies to clear the bus
        - name: trophy-sync.service
          content: |
            [Unit]
            Description=One-shot Time Sync for Matrix
            [Service]
            Type=oneshot
            # Logic: Unmask -> Start -> Enable NTP -> Wait 10s -> Disable NTP -> Stop -> Mask
            ExecStart=/bin/bash -c 'systemctl unmask systemd-timesyncd; systemctl start systemd-timesyncd; timedatectl set-ntp true; sleep 10; timedatectl set-ntp false; systemctl stop systemd-timesyncd; systemctl mask systemd-timesyncd'

        # 2. The Timer: Triggers the service every 30 mins
        - name: trophy-sync.timer
          content: |
            [Unit]
            Description=Run time sync every 30 minutes
            [Timer]
            OnBootSec=5min
            OnUnitActiveSec=30min
            [Install]
            WantedBy=timers.target

    - name: Enable the Time Sync Timer
      systemd:
        name: trophy-sync.timer
        state: started
        enabled: yes
        daemon_reload: yes

    # --- STAGE 1: SYSTEM DEPENDENCIES & NETWORK ---

    - name: Ensure Runtime Dependencies are installed
      apt:
        name:
          - wget
          - git
          - git-lfs
          - network-manager
          - rfkill
          - libatomic1
          - libwebp7
          - libwebpdemux2
          - libwebsockets19t64
        state: present
        update_cache: yes

    - name: Ensure NetworkManager is Managing All Devices
      ini_file:
        path: /etc/NetworkManager/NetworkManager.conf
        section: ifupdown
        option: managed
        value: "true"

    - name: Unblock WiFi Radio
      command: rfkill unblock wifi

    # --- STAGE 2: DEPLOY CODE (Sparse Checkout) ---

    - name: Initialize Git LFS (Global)
      command: git lfs install --system
      args:
        creates: /etc/gitconfig
      become: yes

    - name: Clone repository without checking out files
      command: "git clone --no-checkout --filter=blob:none {{ firmware_repo }} {{ app_dir }}"
      args:
        creates: "{{ app_dir }}/.git"
      become_user: cbtrophy

    - name: Configure sparse-checkout for client folder
      command: git sparse-checkout set client
      args:
        chdir: "{{ app_dir }}"
      become_user: cbtrophy

    - name: Checkout develop branch
      command: git checkout develop
      args:
        chdir: "{{ app_dir }}"
      become_user: cbtrophy

    - name: Pull Git LFS objects
      command: git lfs pull
      args:
        chdir: "{{ app_dir }}"
      become_user: cbtrophy

    - name: Configure Git to ignore 'loop' directory
      lineinfile:
        path: "{{ app_dir }}/.git/info/exclude"
        line: "loop/"
        create: yes
      become_user: cbtrophy

    # --- STAGE 3: ASSET & RUNTIME PREP ---

    - name: Create Runtime Loop Directory (Local Only)
      file:
        path: "{{ app_dir }}/loop"
        state: directory
        owner: cbtrophy
        group: cbtrophy
        mode: '0775'

    - name: Ensure 'trophy' binary is executable
      file:
        path: "{{ app_dir }}/client/trophy"
        mode: '0755'
        owner: cbtrophy
        group: cbtrophy

    # --- STAGE 4: SERVICE DEPLOYMENT ---

    - name: Deploy Systemd Service
      copy:
        dest: /etc/systemd/system/trophy.service
        content: |
          [Unit]
          Description=cbTrophy Display Service
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          User=root
          Group=root
          # Pointing to the new client subfolder
          WorkingDirectory={{ app_dir }}/client
          # We use the standard path. If you need CPU pinning later, add 'taskset -c 3' here.
          ExecStart={{ app_dir }}/client/trophy --dev
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
        owner: root
        group: root
        mode: '0644'
      notify: Restart Trophy Service

  handlers:
    - name: Restart Trophy Service
      systemd:
        name: trophy
        state: restarted
        enabled: yes
        daemon_reload: yes

    # --- STAGE 5: FINALIZATION ---
    # Put reboot task here or handle manually

    - name: Reboot if config.txt was changed
      reboot:
        msg: "Rebooting to disable sound modules and finalize hardware setup"
      when: config_audio.changed